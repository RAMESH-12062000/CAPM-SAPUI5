/* eslint-disable no-undef */
module.exports = {
  meta: {
    schema: [{/* to avoid deprecation warning for ESLint 9 */}],
    docs: {
      description: 'Should make suggestions for possible missing SQL casts.',
      recommended: true
    },
    type: 'suggestion',
    hasSuggestions: true,
    messages: {
      missingSQLCast: 'Potential issue - Missing SQL cast for column expression?'
    }
  },
  create: function (context) {
    return { view: checkSqlCast }

    function checkSqlCast (v) {
      if (v.query && v.query.SET) {
        for (const { SELECT } of v.query.SET.args) {
          // Only in UNION cases?
          for (const each of SELECT.columns || []) {
            const { xpr, cast } = each
            if (cast && xpr) {
              if (xpr[0].xpr && xpr[0].cast) {
                continue
              } else {
                context.report({
                  messageId: 'missingSQLCast',
                  node: context.getNode(v)
                })
              }
            }
          }
        }
      }
    }
  }
}
