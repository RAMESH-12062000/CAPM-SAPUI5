const { base64ToBuffer } = require('../../_runtime/common/utils/binary')

module.exports = srv => (req, res, next) => {
  const { _query, _data, _operation } = req
  let definition = _operation || _query.__target
  if (typeof definition === 'string') definition = srv.model.definitions[definition] || srv.model.definitions[definition.split(':$:')[0]].actions[definition.split(':$:')[1]]

  if (!(_data && srv && definition)) return next()

  base64ToBuffer(_data, srv, definition)

  next()
}
