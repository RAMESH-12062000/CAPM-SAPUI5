const cds = require('../../../')

module.exports = srv =>
  function parse(req, _, next) {
    // REVISIT: can't we register the batch handler before the parse handler to avoid this?
    if (req.path.startsWith('/$batch')) return next()

    // if not a GET, use req.path instead of req.url to ignore query parameters
    req._query = cds.odata.parse(req.method === 'GET' ? req.url : req.path, {
      service: srv,
      baseUrl: req.baseUrl,
      strict: true
    })

    const preferReturn = req.headers.prefer?.match(/\W?return=(\w+)/i)
    if (preferReturn) req._preferReturn = preferReturn[1]

    next()
  }
