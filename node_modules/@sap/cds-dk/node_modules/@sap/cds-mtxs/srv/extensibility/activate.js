const cds = require('@sap/cds/lib')
const Extensions = 'cds.xt.Extensions'

const _updateExtensions = async function (ID, tag) {
  const updateCqn = UPDATE(Extensions)
    .with(`csn = REPLACE(csn, ',"@cds.extension":true', ''), activated = 'database'`)
    .where({ activated: 'propertyBag' })
  if (ID) {
    updateCqn.where('ID =', ID)
  } else if (tag) {
    updateCqn.where('tag =', tag)
  }
  await cds.db.run(updateCqn)
}

const activate = async function ExtensibilityService_activate (ID, tag, tenant, csvs, async) {
  if (tenant) cds.context = { tenant }
  await _updateExtensions(ID, tag)

  if (async) {
    const { 'cds.xt.JobsService': js } = cds.services
    return js.enqueue('extend', [new Set([tenant])], [csvs])
  } else {
    const { 'cds.xt.DeploymentService': ds } = cds.services
    await ds.extend(tenant, csvs)
  }
}

module.exports = activate
