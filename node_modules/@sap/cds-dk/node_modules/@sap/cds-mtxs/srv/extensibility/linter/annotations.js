const LinterMessage = require('./message')

const AT_REQUIRES = '@requires'
const AT_RESTRICT = '@restrict'
const AT_CDS_PERSISTENCE_JOURNAL = '@cds.persistence.journal'
const AT_SQL_APPEND = '@sql.append'
const AT_SQL_PREPEND = '@sql.prepend'

const checkedAnnotations = new Map([
  [AT_REQUIRES, _createSecurityAnnotationWarning],
  [AT_RESTRICT, _createSecurityAnnotationWarning],
  [AT_CDS_PERSISTENCE_JOURNAL, _createJournalAnnotationWarning],
  [AT_SQL_APPEND, _createSqlAnnotationWarning],
  [AT_SQL_PREPEND, _createSqlAnnotationWarning]
])

function _createSqlAnnotationWarning(annotationName, annoOrElem) {
  const message = `Annotation '${annotationName}' in '${
    annoOrElem.annotate || annoOrElem.name
  }' is not supported in extensions`
  return new LinterMessage(message, annoOrElem)
}

function _createSecurityAnnotationWarning(annotationName, annoOrElem) {
  const message = `Security relevant annotation '${annotationName}' in '${
    annoOrElem.annotate || annoOrElem.name
  }' cannot be overwritten`
  return new LinterMessage(message, annoOrElem)
}

function _createJournalAnnotationWarning(annotationName, annoOrElem) {
  const message = `Enabling schema evolution in extensions using '${annotationName}' in '${
    annoOrElem.annotate || annoOrElem.name
  }' not yet supported`
  return new LinterMessage(message, annoOrElem)
}

function _createJournalEntityExtensionNotAllowedWarning(element) {
  const message = `Extending entity '${element.extend}' is not supported as the corresponding database table has been enabled for schema evolution`
  return new LinterMessage(message, element)
}

module.exports = class AnnotationsChecker {
  check(reflectedCsn, fullCsn, compileDir) {
    if (!reflectedCsn.extensions || !reflectedCsn.definitions) {
      return []
    }

    // annotations via annotate - applies for all
    const annotationExtensions = Object.values(reflectedCsn.extensions).filter(
      value => value.annotate && Object.getOwnPropertyNames(value).filter(property => checkedAnnotations.get(property))
    )
    const messages = []

    // check annotations for extensions including fields
    reflectedCsn.forall(
      () => true,
      element => {
        if (element[AT_SQL_PREPEND] || element[AT_SQL_APPEND]) {
          if (!element.annotate) {
            // do not add annotation extensions again
            annotationExtensions.push(element)
          }
        }
        if (element.extend) {
          this._checkExtendedEntityAnnotations(fullCsn, element, messages)
        }
      },
      reflectedCsn.extensions
    )

    // check entities and fields from definitions
    const annotatedDefinitions = []
    reflectedCsn.forall(
      () => true,
      element => {
        if (element[AT_SQL_PREPEND] || element[AT_SQL_APPEND] || element[AT_CDS_PERSISTENCE_JOURNAL]) {
          annotatedDefinitions.push(element)
        }
      },
      reflectedCsn.definitions
    )

    for (const annotationExtension of annotationExtensions) {
      const warning = this._checkAnnotation(annotationExtension, reflectedCsn.definitions, compileDir)
      if (warning) {
        messages.push(warning)
      }
    }

    for (const annotatedDefinition of annotatedDefinitions) {
      const warning = this._checkAnnotation(annotatedDefinition, reflectedCsn.definitions, compileDir)
      if (warning) {
        messages.push(warning)
      }
    }

    return messages
  }

  _checkAnnotation(annotation, definitions, compileDir) {
    if (!definitions[annotation.annotate]) {
      return this._createAnnotationsWarning(annotation, compileDir)
    }

    return null
  }

  _createAnnotationsWarning(annotation) {
    const annotationName = Object.getOwnPropertyNames(annotation).filter(property => checkedAnnotations.get(property))

    if (annotationName.length) {
      const fn = checkedAnnotations.get(annotationName[0]).bind(this)
      return fn(annotationName, annotation)
    }
  }

  _checkExtendedEntityAnnotations(fullCsn, element, messages) {
    const kind = fullCsn.definitions[element.extend]?.kind
    if (kind === 'entity' && fullCsn.definitions[element.extend]?.[AT_CDS_PERSISTENCE_JOURNAL]) {
      messages.push(_createJournalEntityExtensionNotAllowedWarning(element))
    }
  }
}
