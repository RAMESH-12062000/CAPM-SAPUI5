const { EXT_BACK_PACK, hasExtendedEntity, getTargetRead } = require('../../../lib/utils')

// REVISIT: eleminiate usage of these helpers
const getTemplate = require('@sap/cds/libx/_runtime/common/utils/template') // bad
const templateProcessor = require('@sap/cds/libx/_runtime/common/utils/templateProcessor') // bad

const _pick = element => {
  return element['@cds.extension']
}

// The problem here are the extended columss, which are in SELECT.column, but not in the backpack.
// Otherwise all backpack values could be inserted for row at once.
const _processorFn = ({ row, key }) => {
  let extensions__ = row[EXT_BACK_PACK]
  if (extensions__) {
    const extensions = typeof extensions__ === 'object' ? extensions__ : JSON.parse(extensions__)
    if (extensions[key]) {
      row[key] = extensions[key]
      delete extensions[key]
      if (Object.keys(extensions).length === 0) {
        delete row[EXT_BACK_PACK]
      } else {
        row[EXT_BACK_PACK] = JSON.stringify(extensions)
      }

      return
    }
  }

  // Extended fields are not in SELECT.columns.
  // Workaround for fields not from backpack: provide them all
  row[key] = null
}

function transformExtendedFieldsRESULT(result, req) {
  if (!result || !hasExtendedEntity(req, this.model)) return

  const template = getTemplate('transform-result', this, getTargetRead(req), {
    pick: _pick
  })

  if (template.elements.size > 0) {
    const result_ = Array.isArray(result) ? result : [result]
    for (const row of result_) {
      const args = { processFn: _processorFn, row, template }
      templateProcessor(args)
    }
  }
}

module.exports = {
  transformExtendedFieldsRESULT
}
