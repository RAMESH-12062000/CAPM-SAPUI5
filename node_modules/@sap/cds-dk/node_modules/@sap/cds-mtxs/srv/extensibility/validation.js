const cds = require('@sap/cds/lib')

const { getCompilerError } = require('../../lib/utils')

const validateCsn = (csn, appCsn, req) => {
  if (!csn) req.reject(400, 'Missing extension')
  if (!csn.extensions) return

  csn.extensions.forEach(extension => {
    if (!extension.extend || !appCsn.definitions[extension.extend]) {
      req.reject(400, 'Invalid extension. Parameter "extend" missing or malformed')
    }

    if (!extension.elements) {
      req.reject(400, 'Invalid extension. Missing parameter "elements"')
    }
  })
}

const validateExtensionFields = (csn, appCsn, req) => {
  if (!csn.extensions) return

  csn.extensions.forEach(extension => {
    if (extension.elements) {
      Object.keys(extension.elements).forEach(name => {
        if (!/^[A-Za-z]\w*$/.test(name)) {
          req.reject(400, `Invalid extension. Bad element name "${name}"`)
        }

        if (Object.keys(appCsn.definitions[extension.extend].elements).includes(name)) {
          req.reject(400, `Invalid extension. Element "${name}" already exists`)
        }
      })
    }
  })
}

const validateExtension = (ext, csn, req) => {
  try {
    cds.extend(csn).with(ext)
  } catch (err) {
    req.reject(400, getCompilerError(err.messages))
  }
}

module.exports = {
  validateCsn,
  validateExtensionFields,
  validateExtension
}
