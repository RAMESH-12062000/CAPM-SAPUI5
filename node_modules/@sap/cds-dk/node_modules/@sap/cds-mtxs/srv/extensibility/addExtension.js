const cds = require('@sap/cds/lib')

const { validateCsn, validateExtensionFields, validateExtension } = require('./validation')
const handleDefaults = require('./defaults')
const resolveViews = require('./views')

const _getCsn = req => {
  const csn = {
    extensions: req.data.extensions?.map(ext => JSON.parse(ext)) ?? []
  }

  return csn
}

const _addAnnotation = extension => {
  Object.values(extension.elements).forEach(el => {
    el['@cds.extension'] = true
  })
}

const _addViews = (csn, appCsn) => {
  csn.extensions.forEach(extension => {
    const target = appCsn.definitions[extension.extend]
    const views_ = []
    const view = resolveViews(target, views_)
    extension.extend = view && view.name
    _addAnnotation(extension)

    // All projection views leading to the db entity are extended with back pack in case view columns are explicitly listed.
    // The views using projections with '*' obtain the back pack automatically.
    views_.forEach(view => {
      if (!view.projection || (view.projection.columns && !view.projection.columns.some(col => col === '*'))) {
        csn.extensions.push({
          extend: view.name,
          columns: Object.keys(extension.elements).map(key => {
            return { ref: [key] }
          })
        })
      }
    })
  })
}

const _addExtension = async function (csn, appCsn, req) {
  if (req.tenant) cds.context = { tenant: req.tenant }
  await cds.db.run(
    INSERT.into('cds.xt.Extensions').entries([
      { ID: cds.utils.uuid(), tag: 'uiflex', csn: JSON.stringify(csn), activated: 'propertyBag' }
    ])
  )

  for (const ext of req.data.extensions ?? []) {
    const extension = JSON.parse(ext)
    await handleDefaults(extension, appCsn, false)
  }
}

const addExtension = async function (req) {
  const { 'cds.xt.ModelProviderService': mps } = cds.services
  const csn = await mps.getCsn(req.tenant, ['*'])
  const extCsn = _getCsn(req)
  const njCsn = cds.compile.for['nodejs'](csn)
  // REVISIT: Optimize the validations
  // REVISIT: Why do we need njCsn?
  validateCsn(extCsn, njCsn, req)
  validateExtensionFields(extCsn, njCsn, req)
  _addViews(extCsn, njCsn)
  validateExtension(extCsn, csn, req)
  await _addExtension(extCsn, njCsn, req)
}

module.exports = addExtension
