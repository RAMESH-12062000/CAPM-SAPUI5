// Registry of sequence matchers in mta.yaml files
const cds = require('../../cds')

const srvNode4 = path => ({ in: 'modules', where: { type: 'nodejs', path } })
const srvJava4 = path => ({ in: 'modules', where: { type: 'java', path } })
const srv4 = cds.env['project-nature'] === 'java' || cds.cli.options?.add?.has('java') ? srvJava4 : srvNode4

const approuter = { in: 'modules', where: { type: 'approuter.nodejs' } }

const xsuaa = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'xsuaa' }
}

const destination = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'destination' }
}

const connectivity = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'connectivity' }
}

const redis = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'redis-cache' }
}

const enterpriseMessaging = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'enterprise-messaging' }
}

const kafkaMessaging = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'kafka' }
}

const applicationLogging = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'application-logs' }
}

const hdbDeployer = {
    in: 'modules',
    where: { type: 'hdb' }
}

const hdiContainer = {
    in: 'resources',
    where: { type: 'com.sap.xs.hdi-container' }
}

const notificationTypesDeployer = {
    in: 'modules',
    where: { type: 'nodejs', name: 'notification-content-deployment' }
}

const serviceManager = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'service-manager', 'parameters.service-plan': 'container' }
}

const postgres = {
    in: 'resources',
    where: { 'parameters.service': 'postgresql-db' }
}

const postgresDeployer = {
    in: 'modules',
    where: { type: 'nodejs', path: 'gen/pg' }
}

const saasRegistry = {
    in: 'resources',
    where: { type: 'org.cloudfoundry.managed-service', 'parameters.service': 'saas-registry' }
}

const srvApi4 = srv => ({
    in: [srv, 'provides'],
    where: { name: 'srv-api', 'properties.srv-url': '${default-url}' }
})

const mtxSidecar4 = path => ({
    in: 'modules',
    where: { type: 'nodejs', path }
})

const providedMtxApiSidecar4 = mtxSidecar => ({
    in: [mtxSidecar, 'provides'],
    where: { name: 'mtx-api', 'properties.mtx-url': '${default-url}' }
})

const requiredMtxApi = {
    in: [approuter, 'requires'],
    where: { 'properties.name': 'mtx-api', 'properties.url': '~{mtx-url}' }
}

const providedAppApi = {
    in: [approuter, 'provides'],
    where: { name: 'app-api', 'properties.app-protocol': '${protocol}', 'properties.app-uri': '${default-uri}' }
}

const requiredAppApi4 = module => ({
    in: [module, 'requires'],
    where: { name: 'app-api', 'properties.SUBSCRIPTION_URL': '~{app-protocol}://\\${tenant_subdomain}-~{app-uri}' }
})

const requiredMtxSidecarApi4 = srv => ({
    in: [srv, 'requires'],
    where: { 'properties.CDS_MULTITENANCY_SIDECAR_URL': '~{mtx-url}' }
})

const providedJavaApprouterApi4 = srv => ({
    in: [srv, 'requires'],
    where: { 'properties.CDS_MULTITENANCY_APPUI_URL': '~{url}' }
})

const providedJavaApprouterApi = {
    in: [approuter, 'requires'],
    where: { 'properties.url': '${default-url}' }
}

const approuterExtensibility = {
    in: 'routes',
    where: { source: '^/-/cds/.*', destination: 'mtx-api', authenticationType: 'none' }
}

const html5RepoHost = {
    in: 'resources',
    where: { 'parameters.service': 'html5-apps-repo', 'parameters.service-plan': 'app-host' }
}

const html5Runtime = {
    in: 'resources',
    where: { 'parameters.service': 'html5-apps-repo', 'parameters.service-plan': 'app-runtime' }
}

const appContent = {
    in: 'modules',
    where: { type: 'com.sap.application.content' }
}

module.exports = {
    srv4,
    approuter,
    xsuaa,
    destination,
    connectivity,
    enterpriseMessaging,
    kafkaMessaging,
    hdbDeployer,
    hdiContainer,
    notificationTypesDeployer,
    serviceManager,
    postgres,
    postgresDeployer,
    saasRegistry,
    redis,
    srvApi4,
    mtxSidecar4,
    providedMtxApiSidecar4,
    requiredMtxApi,
    requiredMtxSidecarApi4,
    providedAppApi,
    requiredAppApi4,
    providedJavaApprouterApi4,
    providedJavaApprouterApi,
    applicationLogging,
    approuterExtensibility,
    html5RepoHost,
    html5Runtime,
    appContent
}
