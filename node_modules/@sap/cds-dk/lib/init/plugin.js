const { join } = require('path')
const cds = require('../cds')
const { readdir } = cds.utils
const DEBUG = cds.debug('add')
const { env4 } = require('./projectReader')

module.exports = class Plugin {

    constructor() {
        this.name = this.constructor.name.replace(/template/i, '').replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase()
    }

    /**
     * Provides command-line options for the plugin.
     * @returns {Array.<{option: string, flag: string, shortcut?: string, help: string}>}
     */
    options() {
        return []
    }

    /**
     * Gets the required templates.
     * @returns {string[]} An array of strings representing required plugins.
     *                     Returns an empty array by default.
     *                     In general, avoid such dependencies if possible.
     */
    requires() { return [] }

    /**
     * Determines whether a plugin can be run.
     * @returns {Promise<boolean>} A promise that resolves to `true` if the template can be run.
     */
    async canRun() { return true }

    /**
     * Determines if the plugin has already been added to the project.
     * @param {import('@sap/cds').env} env - The env for the 'production' profile.
     * @returns {boolean} - Returns `true` if the template has been added, otherwise `false`.
     */
    static hasInProduction(env) { // eslint-disable-line no-unused-vars
        return false
    }

    /**
     * Runs the plugin.
     */
    async run() { }

    /**
     * Runs the combine operations for interoperability with other plugins.
     */
    async combine() { }





    /* ––––––––––––
       Yeoman Generator
       –––––––––––– */

    /**
     * Runs the finalize operations.
     */
    async finalize() { } // REVISIT: Required for yo-generator, check if needed any more?

    /* ––––––––––––
       Private APIs
       –––––––––––– */

    async combineSupported() {
        DEBUG && console.log()
        DEBUG && console.log('Plugins active for production:')
        const fromDk = await readdir(join(__dirname, './template'))
        const { registered } = require('./add')
        const processPlugins = async (plugins) => {
            for (const plugin of plugins) {
                const Plugin = registered.get(plugin) ?? require('./template/' + plugin)
                const template = new Plugin()
                const inProduction = Plugin.hasInProduction(env4('production'))
                DEBUG && console.log(inProduction ? '✅' : '❌', plugin)
                if (inProduction) await template.combine()
            }
        }

        if (DEBUG) console.log(`\n   ${fromDk.length} from @sap/cds-dk:`)
        await processPlugins(fromDk)
        if (DEBUG) console.log(`\n   ${registered.size} from plugins:`)
        await processPlugins(registered.keys())

        DEBUG && console.log()
    }
}
