/* eslint-disable no-console */

function getMessage(errorText, { error, command, help = command && getCommandHelp(command) } = {}) {
    let message = errorText ? errorText.trim() : '';
    if (error) {
        const includeStack = error.stack && require('../../cds').debug('cli');
        message = message.replace(/(?<!\p{P})$/u, ':'); // Append colon if no punctuation at the end
        message += includeStack ? '\n' : ' ';
        const oriMsg = error.response?.data?.message // case: response body == error
            || error.response?.data?.error?.message  // case: response body == { error }
            || (includeStack ? '' : error.message);
        message += oriMsg;
        if (includeStack) {
            message += (oriMsg ? '\n' : '') + error.stack;
        }
    }
    if (typeof help === 'string') {
        message += require('../../../bin/help').formatHelp(help);
    }
    return message;
}

function getCommandHelp(command) {
    const cli = require('../../../bin/cds');
    return cli?.load(command, () => ({ help: '' }))?.help ?? '';
}

module.exports = {
    getMessage
};
